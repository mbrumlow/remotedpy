<!DOCTYPE html>
<html>
<body>

<canvas id="myCanvas" width="800" height="600" style="image-rendering: pixelated;">
    Your browser does not support the HTML5 canvas tag.</canvas>

<script>

var haveScreenSize = false;

var imgData;
var c = document.getElementById("myCanvas");
var ctx = c.getContext("2d");
var swidth = 0; 
var sheight = 0; 

var ws = new WebSocket("ws://" +window.location.host + "/dpy");
ws.binaryType = "arraybuffer";


var screenSizeUpdate = function(msgevent) { 
    
    var msg = JSON.parse(msgevent.data);
    c.width = msg.Width; 
    c.height = msg.Height;
    c.style.width = msg.Width + 'px'; 
    c.style.height = msg.Height + 'px';
    swidth = msg.Width; 
    sheight = msg.Height;
    haveScreenSize = true;
    imgData = ctx.createImageData(swidth, sheight);
    
    console.log("screen size: ", swidth, "x", sheight);
    
    ws.onmessage = pixelUpdate;
    
};

var pixelUpdate = function(msgevent) {

    var pixelArray = new Uint32Array(msgevent.data);

    var sx = pixelArray[0];
    var sy = pixelArray[1];
    var w = pixelArray[2];
    var h = pixelArray[3];
    
    for ( var y = sy; y < (sy + h); y++ ) {
        for( var x = sx; x < (sx + w); x++ ) {
           
            var o = (((w * y) + x) - ((w * sy) + sx));
            var px = pixelArray[o + 4];
            
            imgData.data[((swidth * y) + x) * 4] = (px & 0x00ff0000) >> 16;
            imgData.data[((swidth * y) + x) * 4 + 1] = (px & 0x0000ff00) >> 8;
            imgData.data[((swidth * y) + x) * 4 + 2] = (px & 0x000000ff)
            imgData.data[((swidth * y) + x) * 4 + 3] = 255; 
        }
    }
    
    ctx.putImageData(imgData, 0, 0);
    
};

ws.onmessage = screenSizeUpdate;


</script>

</body>
</html>

